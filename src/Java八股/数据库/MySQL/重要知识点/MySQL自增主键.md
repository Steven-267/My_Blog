---
icon: pen-to-square
date: 2024-11-23
category:
- 后端
tag:
- MySQL
- 数据库
---
# MySQL自增主键

---

## **1. 自增值保存在哪里？**

### **1.1 自增主键的定义**
- 自增主键（AUTO_INCREMENT）是一种特殊的列属性，用于自动生成唯一的数字值，通常用于主键。

### **1.2 自增值的存储**
- **InnoDB 存储引擎**：自增值存储在 **内存中**，并不会永久存储到磁盘。
    - 每次 MySQL 重启，自增值会从该表的最大主键值重新初始化。
    - 因此，可能存在因重启或删除数据导致的自增值跳跃。
- **MyISAM 存储引擎**：自增值存储在表的 `.MYD` 文件中，即使重启也能保持连续性。

---

## **2. 自增值不连续的场景**

自增主键在某些特定情况下会出现不连续，以下是常见的原因及场景分析。

---

### **2.1 自增值不连续场景 1：事务回滚**

#### **原因**
- 当事务插入了一条记录，但事务未提交或回滚，自增值已经分配并不会被回收。

#### **示例**
```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50)
);

START TRANSACTION;
INSERT INTO users (name) VALUES ('John'); -- id = 1
ROLLBACK;

INSERT INTO users (name) VALUES ('Jane'); -- id = 2
```

#### **结果**
- 即使事务回滚，下一次插入仍然使用自增值 `2`，导致主键不连续。

---

### **2.2 自增值不连续场景 2：删除记录**

#### **原因**
- 删除记录后，自增值不会回退，而是继续从当前最大值递增。

#### **示例**
```sql
DELETE FROM users WHERE id = 1;

INSERT INTO users (name) VALUES ('Alice'); -- id = 3
```

#### **结果**
- 删除记录不会影响自增值分配，后续插入仍然从上次分配的自增值递增。

---

### **2.3 自增值不连续场景 3：主从复制**

#### **原因**
- 在主从复制环境下，自增值可能被配置为不同的增量和起始值，用于避免主从冲突。
- **设置项**：
    - `auto_increment_increment`：自增值的增量。
    - `auto_increment_offset`：自增值的起始偏移量。

#### **示例**
- 主库配置：
  ```sql
  SET GLOBAL auto_increment_increment = 2;
  SET GLOBAL auto_increment_offset = 1;
  ```
- 从库配置：
  ```sql
  SET GLOBAL auto_increment_increment = 2;
  SET GLOBAL auto_increment_offset = 2;
  ```

#### **结果**
- 主库的自增值序列：1, 3, 5, ...
- 从库的自增值序列：2, 4, 6, ...
- 主从之间的自增值序列看似不连续，但可以避免冲突。

---

### **2.4 自增值不连续场景 4：MySQL 重启**

#### **原因**
- InnoDB 存储引擎的自增值存储在内存中，重启后会重新初始化为表中最大主键值的下一个值。
- 如果在数据库崩溃或重启之前，已分配的自增值未被写入表，可能导致跳跃。

#### **示例**
```sql
INSERT INTO users (name) VALUES ('Tom'); -- id = 3
-- MySQL 崩溃或重启
INSERT INTO users (name) VALUES ('Jerry'); -- id = 4
```

#### **结果**
- 如果重启前有分配但未使用的自增值（如 `4`），则后续插入从表中最大主键值加 1 开始。

---

## **3. 小结**

| **场景**                    | **原因**                                                       | **解决方法**                                                     |
|-----------------------------|--------------------------------------------------------------|------------------------------------------------------------------|
| **事务回滚**                | 自增值分配后不回收。                                          | 不可避免，可通过程序逻辑处理。                                    |
| **删除记录**                | 删除记录后自增值不会回退。                                    | 不建议对自增主键有连续性要求。                                   |
| **主从复制**                | 主从库通过不同的增量和偏移量生成自增值。                     | 确保增量和偏移量合理配置，避免冲突。                             |
| **MySQL 重启**              | 重启后自增值从表中最大值重新初始化。                         | 使用其他字段标识数据顺序，如时间戳。                              |

---

### **面试官喜欢的问题分析**

1. **为什么自增主键不连续？**
    - 事务回滚、删除记录、主从复制、自增值存储在内存中等原因都会导致主键不连续。

2. **如何解决自增值不连续的问题？**
    - **核心思路**：
        - 理解自增主键的设计目的，它的主要职责是保证唯一性，而非连续性。
        - 如果业务需要连续的序列，可通过程序或业务层实现自定义编号。

3. **在什么场景下不适合使用自增主键？**
    - 主从复制环境中，可能会导致自增值序列过于分散。
    - 高并发场景可能导致自增主键生成成为瓶颈（如热点插入）。

4. **如何在主从复制中避免自增值冲突？**
    - 配置 `auto_increment_increment` 和 `auto_increment_offset`。
    - 也可通过 UUID 或其他分布式 ID 生成策略解决。

